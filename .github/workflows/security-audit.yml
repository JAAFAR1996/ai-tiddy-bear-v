# ðŸ”’ AI TEDDY BEAR - GitHub Actions Security Workflow
# ==============================================
# ÙØ­Øµ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø«ØºØ±Ø§Øª Ø§Ù„Ø£Ù…Ù†ÙŠØ© ÙˆØ§Ù„ØªØ¨Ø¹ÙŠØ§Øª

name: "ðŸ›¡ï¸ Security & Dependency Audit"

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # ØªØ´ØºÙŠÙ„ ÙŠÙˆÙ…ÙŠ ÙÙŠ 2:00 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Ù†ÙˆØ¹ Ø§Ù„ÙØ­Øµ'
        required: true
        default: 'full'
        type: choice
        options:
          - 'full'
          - 'vulnerabilities'
          - 'dependencies'

env:
  PYTHON_VERSION: '3.11'

jobs:
  dependency-audit:
    name: "ðŸ“¦ ØªØ¯Ù‚ÙŠÙ‚ Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª"
    runs-on: ubuntu-latest
    
    steps:
      - name: "ðŸ“¥ Checkout Repository"
        uses: actions/checkout@v4
        
      - name: "ðŸ Setup Python"
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: "ðŸ“¦ Install Dependencies"
        run: |
          python -m pip install --upgrade pip
          pip install safety bandit semver requests
          
      - name: "ðŸ” Run Custom Dependency Audit"
        run: |
          python security/dependency_audit.py
          
      - name: "ðŸ“Š Upload Audit Results"
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: dependency-audit-results
          path: |
            security/audits/
            requirements-lock.txt
          retention-days: 30

  security-scan:
    name: "ðŸ”’ ÙØ­Øµ Ø§Ù„Ø«ØºØ±Ø§Øª Ø§Ù„Ø£Ù…Ù†ÙŠØ©"
    runs-on: ubuntu-latest
    
    steps:
      - name: "ðŸ“¥ Checkout Repository"
        uses: actions/checkout@v4
        
      - name: "ðŸ Setup Python"
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: "ðŸ›¡ï¸ Install Security Tools"
        run: |
          python -m pip install --upgrade pip
          pip install safety bandit semver
          pip install -r requirements.txt
          
      - name: "ðŸ” Safety Check (Known Vulnerabilities)"
        run: |
          safety check --json --output safety-report.json || true
          
      - name: "ðŸ”’ Bandit Security Scan"
        run: |
          bandit -r src/ -f json -o bandit-report.json || true
          
      - name: "ðŸ“‹ Generate Security Summary"
        run: |
          echo "## ðŸ”’ Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f safety-report.json ]; then
            echo "### ðŸ“¦ Dependency Vulnerabilities" >> $GITHUB_STEP_SUMMARY
            python -c "
import json
try:
    with open('safety-report.json') as f:
        data = json.load(f)
    vulns = data.get('vulnerabilities', [])
    if vulns:
        print(f'âŒ Found {len(vulns)} vulnerabilities')
        for v in vulns[:5]:  # Top 5
            print(f'- **{v.get(\"package_name\", \"Unknown\")}**: {v.get(\"vulnerability\", \"Unknown\")}')
    else:
        print('âœ… No known vulnerabilities found')
except:
    print('âš ï¸ Could not parse safety report')
            " >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Code Security Analysis" >> $GITHUB_STEP_SUMMARY
          
          if [ -f bandit-report.json ]; then
            python -c "
import json
try:
    with open('bandit-report.json') as f:
        data = json.load(f)
    results = data.get('results', [])
    if results:
        high = len([r for r in results if r.get('issue_severity') == 'HIGH'])
        medium = len([r for r in results if r.get('issue_severity') == 'MEDIUM'])
        print(f'âš ï¸ Found {len(results)} security issues (High: {high}, Medium: {medium})')
    else:
        print('âœ… No security issues found in code')
except:
    print('âš ï¸ Could not parse bandit report')
            " >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: "ðŸ“Š Upload Security Reports"
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: security-scan-results
          path: |
            safety-report.json
            bandit-report.json
          retention-days: 30
          
      - name: "âŒ Fail on Critical Vulnerabilities"
        run: |
          # ÙØ­Øµ Ø§Ù„Ø«ØºØ±Ø§Øª Ø§Ù„Ø­Ø±Ø¬Ø©
          python -c "
import json
import sys

critical_found = False

# ÙØ­Øµ Safety
try:
    with open('safety-report.json') as f:
        safety_data = json.load(f)
    vulns = safety_data.get('vulnerabilities', [])
    critical_vulns = [v for v in vulns if 'critical' in v.get('vulnerability', '').lower()]
    if critical_vulns:
        print(f'ðŸš¨ CRITICAL: Found {len(critical_vulns)} critical vulnerabilities!')
        critical_found = True
except:
    pass

# ÙØ­Øµ Bandit
try:
    with open('bandit-report.json') as f:
        bandit_data = json.load(f)
    results = bandit_data.get('results', [])
    high_issues = [r for r in results if r.get('issue_severity') == 'HIGH']
    if len(high_issues) > 5:  # Ø£ÙƒØ«Ø± Ù…Ù† 5 Ù…Ø´Ø§ÙƒÙ„ Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ø®Ø·ÙˆØ±Ø©
        print(f'ðŸš¨ CRITICAL: Found {len(high_issues)} high-severity security issues!')
        critical_found = True
except:
    pass

if critical_found:
    sys.exit(1)
else:
    print('âœ… No critical security issues found')
          "

  dependabot-config:
    name: "ðŸ¤– ØªØ­Ø¯ÙŠØ« ØªÙƒÙˆÙŠÙ† Dependabot"
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: "ðŸ“¥ Checkout Repository"
        uses: actions/checkout@v4
        
      - name: "ðŸ¤– Create/Update Dependabot Config"
        run: |
          mkdir -p .github
          cat > .github/dependabot.yml << 'EOF'
          # ðŸ¤– AI TEDDY BEAR - Dependabot Configuration
          # ==========================================
          # ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„ØªØ¨Ø¹ÙŠØ§Øª Ù…Ø¹ ÙØ­Øµ Ø£Ù…Ù†ÙŠ
          
          version: 2
          updates:
            # Python dependencies
            - package-ecosystem: "pip"
              directory: "/"
              schedule:
                interval: "daily"
                time: "04:00"
                timezone: "UTC"
              open-pull-requests-limit: 10
              target-branch: "develop"
              commit-message:
                prefix: "â¬†ï¸"
                include: "scope"
              labels:
                - "dependencies"
                - "security"
              reviewers:
                - "JAAFAR1996"
              assignees:
                - "JAAFAR1996"
              # ØªØ¬Ø§Ù‡Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„Ø­Ø²Ù… Ø§Ù„Ø­Ø±Ø¬Ø©
              ignore:
                - dependency-name: "fastapi"
                  update-types: ["version-update:semver-major"]
                - dependency-name: "sqlalchemy"
                  update-types: ["version-update:semver-major"]
                - dependency-name: "cryptography"
                  update-types: ["version-update:semver-major"]
              # ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ Ù„Ù„Ø«ØºØ±Ø§Øª Ø§Ù„Ø£Ù…Ù†ÙŠØ©
              security-updates:
                enabled: true
                
            # GitHub Actions
            - package-ecosystem: "github-actions"
              directory: "/"
              schedule:
                interval: "weekly"
                day: "monday"
                time: "04:00"
                timezone: "UTC"
              commit-message:
                prefix: "ðŸ”§"
              labels:
                - "github-actions"
                - "ci-cd"
          EOF
          
      - name: "ðŸ“ Commit Dependabot Config"
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .github/dependabot.yml
          git diff --staged --quiet || git commit -m "ðŸ¤– Update Dependabot configuration"
          git push || true

  security-policy:
    name: "ðŸ“‹ ØªØ­Ø¯ÙŠØ« Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø£Ù…Ø§Ù†"
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: "ðŸ“¥ Checkout Repository"
        uses: actions/checkout@v4
        
      - name: "ðŸ“‹ Create Security Policy"
        run: |
          cat > SECURITY.md << 'EOF'
          # ðŸ”’ Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø£Ù…Ø§Ù† - AI Teddy Bear
          
          ## ðŸš¨ Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù† Ø§Ù„Ø«ØºØ±Ø§Øª Ø§Ù„Ø£Ù…Ù†ÙŠØ©
          
          Ø¥Ø°Ø§ Ø§ÙƒØªØ´ÙØª Ø«ØºØ±Ø© Ø£Ù…Ù†ÙŠØ© ÙÙŠ AI Teddy BearØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¥Ø¨Ù„Ø§Øº Ø¹Ù†Ù‡Ø§ Ø¨Ø´ÙƒÙ„ Ù…Ø³Ø¤ÙˆÙ„:
          
          1. **Ù„Ø§ ØªÙ‚Ù… Ø¨Ù†Ø´Ø± Ø§Ù„Ø«ØºØ±Ø© Ø¹Ù„Ù†Ø§Ù‹**
          2. Ø£Ø±Ø³Ù„ ØªÙ‚Ø±ÙŠØ±Ø§Ù‹ Ù…ÙØµÙ„Ø§Ù‹ Ø¥Ù„Ù‰: security@ai-teddy-bear.com
          3. Ø³Ù†Ø±Ø¯ Ø¹Ù„ÙŠÙƒ Ø®Ù„Ø§Ù„ 48 Ø³Ø§Ø¹Ø©
          4. Ø³Ù†Ø¹Ù…Ù„ Ù…Ø¹Ùƒ Ù„Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©
          5. Ø³Ù†Ø´ÙƒØ±Ùƒ ÙÙŠ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù…Ø§Ù† (Ø¥Ø°Ø§ Ø±ØºØ¨Øª)
          
          ## ðŸ›¡ï¸ Ø§Ù„Ø«ØºØ±Ø§Øª Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©
          
          | Ø§Ù„Ø¥ØµØ¯Ø§Ø± | Ù…Ø¯Ø¹ÙˆÙ… Ø¨Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ø£Ù…Ù†ÙŠØ© |
          | ------- | ----------------------- |
          | 1.x.x   | âœ… Ù†Ø¹Ù…                  |
          | < 1.0   | âŒ Ù„Ø§                   |
          
          ## ðŸ”’ Ø£ÙØ¶Ù„ Ø§Ù„Ù…Ù…Ø§Ø±Ø³Ø§Øª Ø§Ù„Ø£Ù…Ù†ÙŠØ©
          
          ### Ù„Ù„Ù…Ø·ÙˆØ±ÙŠÙ†:
          - Ø§Ø³ØªØ®Ø¯Ù… `requirements-lock.txt` Ù„Ù„Ø¥ØµØ¯Ø§Ø±Ø§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ©
          - Ø´ØºÙ„ `python security/dependency_audit.py` Ù‚Ø¨Ù„ ÙƒÙ„ Ø¥ØµØ¯Ø§Ø±
          - Ø±Ø§Ø¬Ø¹ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø£Ù…Ø§Ù† ÙÙŠ `security/audits/`
          - ØªØ§Ø¨Ø¹ ØªØ­Ø¯ÙŠØ«Ø§Øª Dependabot
          
          ### Ù„Ù„Ù†Ø´Ø±:
          - Ø§Ø³ØªØ®Ø¯Ù… Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© Ù„Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø³Ø±ÙŠØ©
          - ÙØ¹Ù„ HTTPS ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬
          - Ø§Ø³ØªØ®Ø¯Ù… Ù‚ÙˆØ§Ø¹Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù†ÙØµÙ„Ø© Ù„Ù„Ø¥Ù†ØªØ§Ø¬
          - Ø±Ø§Ù‚Ø¨ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø£Ù…Ù†ÙŠØ©
          
          ## ðŸ“ž Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø·Ø§Ø±Ø¦
          
          ÙÙŠ Ø­Ø§Ù„Ø© Ø§ÙƒØªØ´Ø§Ù Ø«ØºØ±Ø© Ø­Ø±Ø¬Ø© ÙÙŠ Ø§Ù„Ø¥Ù†ØªØ§Ø¬:
          
          1. **ÙÙˆØ±ÙŠ**: Ø£ÙˆÙ‚Ù Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ØªØ£Ø«Ø±Ø©
          2. **Ø®Ù„Ø§Ù„ Ø³Ø§Ø¹Ø©**: Ù‚Ù… Ø¨ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø¤Ù‚Øª
          3. **Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©**: Ø§Ù†Ø´Ø± Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
          4. **Ø®Ù„Ø§Ù„ 48 Ø³Ø§Ø¹Ø©**: Ø£Ø±Ø³Ù„ ØªÙ‚Ø±ÙŠØ±Ø§Ù‹ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
          
          ---
          
          Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          EOF
          
      - name: "ðŸ“ Commit Security Policy"
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add SECURITY.md
          git diff --staged --quiet || git commit -m "ðŸ“‹ Update security policy"
          git push || true
