# Security Configuration for AI Teddy Bear Production
# Enhanced security settings for child-safe AI platform

# Hide nginx version and server information
server_tokens off;
more_clear_headers Server;

# Security headers
add_header X-Frame-Options "DENY" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header X-Content-Type-Options "nosniff" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
add_header X-Permitted-Cross-Domain-Policies "none" always;
add_header Cross-Origin-Embedder-Policy "require-corp" always;
add_header Cross-Origin-Opener-Policy "same-origin" always;
add_header Cross-Origin-Resource-Policy "same-origin" always;

# Content Security Policy for child safety
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'; connect-src 'self' https:; media-src 'self'; object-src 'none'; child-src 'none'; worker-src 'none'; frame-ancestors 'none'; form-action 'self'; base-uri 'self'; upgrade-insecure-requests;" always;

# COPPA and child safety headers
add_header X-COPPA-Compliant "true" always;
add_header X-Child-Safe "true" always;
add_header X-Content-Filter "strict" always;
add_header X-Age-Verification "required" always;

# Permissions Policy (formerly Feature Policy)
add_header Permissions-Policy "geolocation=(), microphone=(self), camera=(self), payment=(), usb=(), accelerometer=(), gyroscope=(), magnetometer=(), clipboard-read=(), clipboard-write=(self)" always;

# Block common attack patterns
location ~* \.(bat|exe|cmd|sh|cgi|pl|jar)$ {
    deny all;
    return 404;
}

# Block access to hidden files
location ~ /\. {
    deny all;
    access_log off;
    log_not_found off;
}

# Block access to backup files
location ~* ~$ {
    deny all;
    access_log off;
    log_not_found off;
}

# Block access to configuration files
location ~* \.(conf|ini|log|bak|old|orig|save|swo|swp|tmp)$ {
    deny all;
    return 404;
}

# Block suspicious user agents
if ($http_user_agent ~* (Nikto|Sqlmap|Fimap|Nessus|whatweb|Openvas)) {
    return 444;
}

# Block empty user agents
if ($http_user_agent = "") {
    return 444;
}

# Block requests with suspicious methods
if ($request_method !~ ^(GET|HEAD|POST|PUT|DELETE|OPTIONS)$ ) {
    return 444;
}

# Rate limiting for security
limit_req_zone $binary_remote_addr zone=security:10m rate=10r/m;
limit_req zone=security burst=5 nodelay;

# Connection limiting
limit_conn_zone $binary_remote_addr zone=conn_limit:10m;
limit_conn conn_limit 10;

# Buffer overflow protection
client_body_buffer_size 1K;
client_header_buffer_size 1k;
client_max_body_size 10M;  # Increased for audio file uploads
large_client_header_buffers 2 1k;

# Timeout protection
client_body_timeout 60;
client_header_timeout 60;
keepalive_timeout 65;
send_timeout 60;