# ðŸ§¸ AI TEDDY BEAR V5 - FLUENT BIT CONFIGURATION
# ==============================================
# Production logging configuration for Docker containers
# with COPPA compliance and child safety filtering

[SERVICE]
    Flush         5
    Daemon        off
    Log_Level     info
    Parsers_File  parsers.conf
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020
    Health_Check  On
    storage.path  /tmp/fluent-bit-storage/
    storage.sync  normal
    storage.checksum off
    storage.backlog.mem_limit 10M

# Docker container logs input
[INPUT]
    Name              forward
    Listen            0.0.0.0
    Port              24224
    storage.type      filesystem
    Mem_Buf_Limit     50MB
    Skip_Long_Lines   On
    Refresh_Interval  30

# System logs input
[INPUT]
    Name              systemd
    Tag               systemd.*
    Systemd_Filter    _SYSTEMD_UNIT=docker.service
    Read_From_Tail    On

# Docker daemon logs
[INPUT]
    Name              tail
    Path              /var/log/docker.log
    Tag               docker.daemon
    Parser            docker
    Mem_Buf_Limit     10MB
    Skip_Long_Lines   On
    Refresh_Interval  10

# AI Teddy Bear application logs
[INPUT]
    Name              tail
    Path              /var/log/ai-teddy-bear/*.log
    Tag               ai-teddy.*
    Parser            json
    Mem_Buf_Limit     50MB
    Skip_Long_Lines   On
    Refresh_Interval  5
    multiline.parser  multiline-json

# Child safety logs (high priority)
[INPUT]
    Name              tail
    Path              /var/log/ai-teddy-bear/child-safety/*.log
    Tag               child-safety.*
    Parser            json
    Mem_Buf_Limit     20MB
    Skip_Long_Lines   On
    Refresh_Interval  1

# Security logs (high priority)
[INPUT]
    Name              tail
    Path              /var/log/ai-teddy-bear/security/*.log
    Tag               security.*
    Parser            json
    Mem_Buf_Limit     20MB
    Skip_Long_Lines   On
    Refresh_Interval  1

# COPPA compliance audit logs
[INPUT]
    Name              tail
    Path              /var/log/ai-teddy-bear/audit/*.log
    Tag               audit.*
    Parser            json
    Mem_Buf_Limit     30MB
    Skip_Long_Lines   On
    Refresh_Interval  2

# Filter: Add environment and instance metadata
[FILTER]
    Name              record_modifier
    Match             *
    Record environment ${ENVIRONMENT}
    Record instance_id ${INSTANCE_ID}
    Record region ${AWS_REGION}
    Record service ai-teddy-bear
    Record version ${APP_VERSION}

# Filter: Child safety compliance - remove PII
[FILTER]
    Name              modify
    Match             child-safety.*
    Remove            child_name
    Remove            child_real_name
    Remove            parent_name
    Remove            parent_email
    Remove            guardian_email
    Remove            phone_number
    Remove            home_address
    Remove            school_name
    Remove            ip_address
    Remove            device_imei
    Remove            location_coords

# Filter: Security log sanitization
[FILTER]
    Name              modify
    Match             security.*
    Remove            password
    Remove            api_key
    Remove            secret
    Remove            token
    Remove            authorization
    Remove            session_id

# Filter: Parse JSON logs and add structured fields
[FILTER]
    Name              parser
    Match             ai-teddy.*
    Key_Name          log
    Parser            json
    Reserve_Data      On
    Preserve_Key      On

# Filter: Add severity mapping for alerts
[FILTER]
    Name              modify
    Match             *
    Condition         Key_Value_Equals level ERROR
    Add               severity high

[FILTER]
    Name              modify
    Match             *
    Condition         Key_Value_Equals level CRITICAL
    Add               severity critical

[FILTER]
    Name              modify
    Match             child-safety.*
    Add               severity child_safety_critical

# Filter: Rate limiting for high-volume logs
[FILTER]
    Name              throttle
    Match             ai-teddy.debug
    Rate              100
    Window            60
    Interval          1m

# Filter: Multiline log handling for stack traces
[FILTER]
    Name              multiline
    Match             ai-teddy.*
    multiline.key_content log
    multiline.parser      multiline-json

# Output: Send to Elasticsearch
[OUTPUT]
    Name              es
    Match             *
    Host              ${ELASTICSEARCH_HOST}
    Port              ${ELASTICSEARCH_PORT}
    HTTP_User         ${ELASTICSEARCH_USER}
    HTTP_Passwd       ${ELASTICSEARCH_PASSWORD}
    Index             ai-teddy-logs
    Type              _doc
    Logstash_Format   On
    Logstash_Prefix   ai-teddy
    Logstash_DateFormat %Y.%m.%d
    Include_Tag_Key   On
    Tag_Key           @tag
    Time_Key          @timestamp
    Replace_Dots      On
    Retry_Limit       5
    storage.total_limit_size 1G
    tls               Off
    tls.verify        Off

# Output: Send child safety logs to dedicated index
[OUTPUT]
    Name              es
    Match             child-safety.*
    Host              ${ELASTICSEARCH_HOST}
    Port              ${ELASTICSEARCH_PORT}
    HTTP_User         ${ELASTICSEARCH_USER}
    HTTP_Passwd       ${ELASTICSEARCH_PASSWORD}
    Index             ai-teddy-child-safety
    Type              _doc
    Logstash_Format   On
    Logstash_Prefix   ai-teddy-child-safety
    Logstash_DateFormat %Y.%m.%d
    Include_Tag_Key   On
    Tag_Key           @tag
    Time_Key          @timestamp
    Replace_Dots      On
    Retry_Limit       10
    storage.total_limit_size 2G
    tls               Off
    tls.verify        Off

# Output: Send security logs to dedicated index
[OUTPUT]
    Name              es
    Match             security.*
    Host              ${ELASTICSEARCH_HOST}
    Port              ${ELASTICSEARCH_PORT}
    HTTP_User         ${ELASTICSEARCH_USER}
    HTTP_Passwd       ${ELASTICSEARCH_PASSWORD}
    Index             ai-teddy-security
    Type              _doc
    Logstash_Format   On
    Logstash_Prefix   ai-teddy-security
    Logstash_DateFormat %Y.%m.%d
    Include_Tag_Key   On
    Tag_Key           @tag
    Time_Key          @timestamp
    Replace_Dots      On
    Retry_Limit       10
    storage.total_limit_size 2G
    tls               Off
    tls.verify        Off

# Output: Send audit logs to dedicated index with extended retention
[OUTPUT]
    Name              es
    Match             audit.*
    Host              ${ELASTICSEARCH_HOST}
    Port              ${ELASTICSEARCH_PORT}
    HTTP_User         ${ELASTICSEARCH_USER}
    HTTP_Passwd       ${ELASTICSEARCH_PASSWORD}
    Index             ai-teddy-audit
    Type              _doc
    Logstash_Format   On
    Logstash_Prefix   ai-teddy-audit
    Logstash_DateFormat %Y.%m.%d
    Include_Tag_Key   On
    Tag_Key           @tag
    Time_Key          @timestamp
    Replace_Dots      On
    Retry_Limit       10
    storage.total_limit_size 5G
    tls               Off
    tls.verify        Off

# Output: Send critical alerts to external webhook
[OUTPUT]
    Name              http
    Match             *
    Host              ${ALERT_WEBHOOK_HOST}
    Port              443
    URI               /alerts/webhook
    Header            Authorization Bearer ${ALERT_WEBHOOK_TOKEN}
    Header            Content-Type application/json
    Format            json
    json_date_key     timestamp
    json_date_format  iso8601
    Retry_Limit       3
    tls               On
    tls.verify        On
    # Only send critical alerts
    Match_Regex       severity (critical|child_safety_critical)

# Output: Backup to file for compliance
[OUTPUT]
    Name              file
    Match             audit.*
    Path              /var/log/ai-teddy-bear/backup/
    File              audit-backup.log
    Format            json_lines