[platformio]
default_envs = teddy_bear_production
src_dir = src_production

[common]
platform = espressif32@6.6.0
framework = arduino
board = esp32dev
monitor_speed = 115200

lib_deps = 
    bblanchon/ArduinoJson@^7.0.4
    Links2004/WebSockets@^2.6.1
    ottowinter/ESPAsyncWebServer-esphome@^3.2.2
    esphome/ESP32-audioI2S@^2.0.7
    knolleary/PubSubClient@^2.8.0
    rweather/Crypto@^0.4.0

build_flags = 
    -DCORE_DEBUG_LEVEL=1
    -DARDUINOJSON_ENABLE_PROGMEM=1
    -DWEBSOCKETS_SSL_ENABLE=1
    -DBOARD_HAS_PSRAM
    -mfix-esp32-psram-cache-issue
    -DUSE_ESP32_DEV_MODULE
    -DESP32_PERFORMANCE_MODE=1

# üß∏ Production Environment ŸÑŸÑŸÄ AI Teddy Bear
[env:teddy_bear_production]
platform = ${common.platform}
framework = ${common.framework}
board = ${common.board}
monitor_speed = ${common.monitor_speed}
lib_deps = ${common.lib_deps}

# ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿ•ŸÜÿ™ÿßÿ¨
build_flags = 
    ${common.build_flags}
    -DPRODUCTION_BUILD=1
    -DDEVICE_MODEL=\"AI-TeddyBear-ESP32\"
    -DFIRMWARE_VERSION=\"1.0.0-production\"
    -DSERVER_HOST=\"ai-tiddy-bear-v-xuqy.onrender.com\"
    -DSERVER_PORT=443
    -DWS_ENDPOINT=\"/api/v1/esp32/private/chat\"
    -DENABLE_SECURITY=1
    -DENABLE_TLS_VALIDATION=1
    -DENABLE_HMAC_SIGNATURES=1
    -DENABLE_JWT_VALIDATION=1
    -DMIN_CHILD_AGE=3
    -DMAX_CHILD_AGE=13
    -DAUDIO_SAMPLE_RATE=16000
    -DAUDIO_BITS_PER_SAMPLE=16
    -DAUDIO_CHANNELS=1

# Partition table ŸÑŸÑŸÄ OTA
board_build.partitions = partitions.csv
board_build.filesystem = spiffs

# Memory optimization
board_build.f_cpu = 240000000L
board_build.f_flash = 80000000L
board_build.flash_mode = dio

# Upload settings
upload_speed = 921600
monitor_filters = esp32_exception_decoder, time

# Extra scripts
extra_scripts = 
    scripts/build_check.py
    scripts/validate-build.sh

# üîß Development Environment ŸÑŸÑÿßÿÆÿ™ÿ®ÿßÿ±
[env:teddy_bear_development]  
platform = ${common.platform}
framework = ${common.framework}
board = ${common.board}
monitor_speed = ${common.monitor_speed}
lib_deps = ${common.lib_deps}

build_flags = 
    ${common.build_flags}
    -DDEBUG_BUILD=1
    -DCORE_DEBUG_LEVEL=4
    -DDEVICE_MODEL=\"AI-TeddyBear-ESP32-DEV\"
    -DFIRMWARE_VERSION=\"1.0.0-development\"
    -DSERVER_HOST=\"localhost\"
    -DSERVER_PORT=8080
    -DWS_ENDPOINT=\"/api/v1/esp32/private/chat\"
    -DENABLE_SECURITY=0
    -DENABLE_DEBUG_LOGS=1
    -DENABLE_SERIAL_DEBUG=1
    -DENABLE_TEST_MODES=1
    -DMOCK_AUDIO_INPUT=1
    -DSTRICT_TLS_VALIDATION=0

board_build.partitions = partitions.csv
board_build.filesystem = spiffs
upload_speed = 115200
monitor_filters = esp32_exception_decoder, time, default

# üß™ Testing Environment ŸÑŸÑŸÄ CI/CD
[env:teddy_bear_testing]
platform = ${common.platform}
framework = ${common.framework}
board = ${common.board}
monitor_speed = ${common.monitor_speed}
lib_deps = 
    ${common.lib_deps}
    throwtheswitch/Unity@^2.5.2

build_flags = 
    ${common.build_flags}
    -DTEST_BUILD=1
    -DCORE_DEBUG_LEVEL=3
    -DDEVICE_MODEL=\"AI-TeddyBear-ESP32-TEST\"
    -DFIRMWARE_VERSION=\"1.0.0-testing\"
    -DENABLE_UNITY_TESTING=1
    -DENABLE_MOCK_SERVICES=1
    -DENABLE_PERFORMANCE_TESTING=1

test_framework = unity
test_build_src = yes

# üìä Performance Monitoring Environment
[env:teddy_bear_performance]
platform = ${common.platform}
framework = ${common.framework}
board = esp32-s3-devkitc-1  # ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ£ÿØÿßÿ° ÿ£ŸÅÿ∂ŸÑ
monitor_speed = ${common.monitor_speed}
lib_deps = ${common.lib_deps}

build_flags = 
    ${common.build_flags}
    -DPERFORMANCE_BUILD=1
    -DBOARD_HAS_PSRAM
    -DESP32_ENABLE_PSRAM_CACHE=1
    -DESP32_PSRAM_SIZE_8MB=1
    -DENABLE_PERFORMANCE_MONITORING=1
    -DENABLE_MEMORY_PROFILING=1
    -DENABLE_AUDIO_LATENCY_MEASUREMENT=1

board_build.f_cpu = 240000000L
board_build.f_flash = 80000000L

# üîí Security Audit Environment  
[env:teddy_bear_security_audit]
platform = ${common.platform}
framework = ${common.framework}
board = ${common.board}
monitor_speed = ${common.monitor_speed}
lib_deps = ${common.lib_deps}

build_flags = 
    ${common.build_flags}
    -DSECURITY_AUDIT_BUILD=1
    -DENABLE_SECURITY_LOGGING=1
    -DENABLE_INTRUSION_DETECTION=1
    -DENABLE_CRYPTO_SELF_TESTS=1
    -DENABLE_TLS_DEBUG=1
    -DSTRICT_SECURITY_MODE=1
    -DMAX_SECURITY_VIOLATIONS=3
    -DSECURITY_EVENT_LOGGING=1

# Common build targets
[env:check_syntax]
platform = ${common.platform}
framework = ${common.framework}
board = ${common.board}
build_flags = 
    -DSYNTAX_CHECK_ONLY=1
    -Wextra
    -Wall
    -Wunused-function
    -Wunused-variable
    
# Size analysis
[env:analyze_size]
platform = ${common.platform}
framework = ${common.framework} 
board = ${common.board}
build_flags = 
    ${common.build_flags}
    -DPRODUCTION_BUILD=1
extra_scripts = 
    scripts/memory_analysis.py
