# مخطط ربط الأجهزة — ESP32 AI Teddy Bear (التقاط وإرسال صوت فقط)

الغرض: ربط ميكروفون إلكترِت مع مضخّم/حساس صوت HW‑164 بلوحة ESP32‑WROOM‑32U لالتقاط الصوت وإرساله إلى الخادم (بدون تشغيل صوتي). يتضمن الملف أيضًا ربطًا اختياريًا للسبيكر عبر مضخّم خارجي.

## نظرة عامة

- نوع الميكروفون لديك: إلكترِت + مضخّم/حساس صوت HW‑164 (لوحة زرقاء)
- نوع اللوحة: ESP32‑WROOM‑32U (DevKit)
- السبيكر: 8Ω صغير (اختياري — غير مستخدم في وضع “يسمع ويرسل فقط”)

يعطي HW‑164 إشارة تناظرية (Analog) على طرف AO، لذلك يجب القراءة عبر **ADC** في ESP32 (وليس I2S).

## مخطط كتلي مبسّط

```
[Electret Mic] → [HW-164 Amp/Detector] → (AO) ──> [ESP32 ADC1 (GPIO34)]
                                 (GND) ──> [ESP32 GND]
                                 (VCC) ──> [ESP32 3V3]

(اختياري) [ESP32 DAC/GPIO] → [PAM8403 / Amp خارجي] → [Speaker 8Ω]
```

## جدول التوصيلات (الأساسي)

| HW‑164 | الوصف              | ESP32‑WROOM‑32U |
|-------:|--------------------|-----------------|
| VCC    | تغذية 3.3V        | 3V3             |
| GND    | أرضي مشترك        | GND             |
| AO     | خرج تناظري للصوت  | GPIO34 (ADC1_CH6) |
| DO     | خرج رقمي (عتبة)   | غير موصول (اختياري) |

ملاحظات:
- يُفضَّل تغذية HW‑164 من 3.3V حتى لا يتجاوز AO حد 3.3V للـ ADC. إن اضطررت لتغذيته 5V، ضع قاسم جهد 2:1 قبل إدخال ESP32.
- استخدم دائمًا قنوات **ADC1** (مثل GPIO34/36/39/32/33/35) مع الـ Wi‑Fi. لا تستخدم ADC2 لأنه يتعارض مع الراديو.

## ربط السبيكر (اختياري — غير مستخدم افتراضيًا)

لا توصل السبيكر مباشرةً بلوحة ESP32. استخدم مضخّم صوت (مثل PAM8403):

| PAM8403 | الوصف        | المصدر/اللوحة |
|--------:|--------------|----------------|
| VCC     | تغذية 5V     | 5V ثابت (USB/منظّم) |
| GND     | أرضي          | GND مشترك |
| L_IN/R_IN | دخل صوت     | من ESP32 DAC (GPIO25/26) عبر مكثّف ربط 1µF إن لزم |
| SPK+/-  | خرج للسبيكر  | إلى السبيكر 8Ω |

> في هذا المشروع تم تعطيل التشغيل الصوتي (Playback) لتقليل استهلاك الذاكرة والطاقة. اترك السبيكر والمضخّم مفصولين ما لم ترغب بتمكينه لاحقًا.

## إعدادات الفيرموير ذات الصلة

افتراضيًا تم تهيئة الفيرموير للوضع الآتي:

- التقاط عبر **ADC1** (تناظري) من GPIO34
- تعطيل التشغيل الصوتي (Playback) نهائيًا

الملف: `include/feature_config.h`

```c
// تشغيل/تعطيل تشغيل الصوت
#define FEATURE_AUDIO_PLAYBACK          0

// اختيار إدخال الصوت: 1 = ADC (ميكروفون تناظري)، 0 = I2S (ميكروفون رقمي)
#define FEATURE_AUDIO_ADC_INPUT         1

// اختيار قناة ADC (GPIO34 = ADC1_CHANNEL_6)
#define AUDIO_ADC_CHANNEL               ADC1_CHANNEL_6
```

تلميحات:
- لو أردت استخدام رجل أخرى من ADC1، غيّر `AUDIO_ADC_CHANNEL` بما يناسب (مثل `ADC1_CHANNEL_0` لـ GPIO36). حافظ على استخدام ADC1 فقط.

## اختبار سريع للهاردوير

1) بعد التوصيل، شغّل اللوحة وافتح منفذ السيريال. 
2) راقب رسائل “WiFi connected” ثم “Audio system initialized”.
3) اختبر قراءة الصوت:
   - تحدّث قرب الميكروفون؛ يجب أن تتغيّر القيم وترسل الإطارات إلى الخادم حسب الإعدادات.
   - إن كان الصوت ضعيفًا/مشوّهًا: لفّ مسمار البوتنشيوميتر على HW‑164 لتعديل الكسب (Gain).

## استكشاف الأخطاء الشائعة

- القيم دائمًا عالية (قريبة 4095):
  - الجهد على AO مرتفع. غيّر تغذية HW‑164 إلى 3.3V، أو اخفض الجين من البوتنشيوميتر.
  - استخدم قاسم جهد إذا كانت تغذية HW‑164 = 5V.

- القيم ثابتة أو 0 دائمًا:
  - تأكد من GND مشترك.
  - تأكد من توصيل AO على GPIO34 بالفعل (وليس على رجل أخرى).
  - قصّر طول الأسلاك وحسّن التأريض لتقليل الضجيج.

- Wi‑Fi يتقطع عند القراءة:
  - تأكد من أنك على قنوات **ADC1** فقط (تجنّب ADC2 تمامًا).

## قائمة المواد (BOM) مقتضبة

- ESP32‑WROOM‑32U DevKit (1x)
- ميكروفون إلكترِت + لوحة HW‑164 (1x)
- أسلاك توصيل (Dupont) قصيرة
- (اختياري) مضخّم صوت PAM8403 + سبيكر 8Ω + تغذية 5V منفصلة

---

هذا المخطط مُحسَّن لوضع “يسمع ويرسل فقط”. عند الرغبة بتمكين التشغيل لاحقًا، نربط مضخّم الصوت كما في القسم الاختياري ونُعيد تفعيل `FEATURE_AUDIO_PLAYBACK` في `feature_config.h` مع ضبط أرجل I2S/DAC وفق المتاح لديك.

